<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>QR Scanner</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; font-family: sans-serif; }
    #reader { width: 100vw; height: 100vh; transition: transform 0.1s; }
    
    /* æ ¸å¿ƒï¼šæˆåŠŸé–ƒçˆå±¤ */
    #flash {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(40, 167, 69, 0.8);
      display: none; z-index: 999; pointer-events: none;
      border: 20px solid #28a745;
      box-sizing: border-box;
    }

    /* æƒææˆåŠŸæ™‚çš„éœ‡å‹•èˆ‡ç¸®æ”¾æ•ˆæœ */
    .scan-success-effect {
      animation: pulse-visual 0.4s ease-out;
    }

    @keyframes pulse-visual {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    /* åˆ‡æ›æŒ‰éˆ• */
    #switch-btn {
      position: fixed; bottom: 30px; right: 30px;
      width: 55px; height: 55px; background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.4); border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      z-index: 1000; backdrop-filter: blur(10px); cursor: pointer;
    }
    #switch-btn svg { fill: white; width: 28px; height: 28px; }

    /* é¡¯ç¤ºç›®å‰ç‹€æ…‹çš„å°æ¨™ç±¤ */
    #status-tip {
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,0.5); color: #fff; padding: 5px 15px;
      border-radius: 20px; font-size: 12px; z-index: 1000; pointer-events: none;
      white-space: nowrap;
    }
  </style>
</head>
<body>

  <div id="status-tip">ç­‰å¾… QR Code...</div>
  <div id="flash"></div>
  <div id="reader"></div>
  
  <div id="switch-btn" onclick="switchCamera()">
    <svg viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg>
  </div>

  <script>
    // âš ï¸ è¨˜å¾—ï¼šåªè¦ä½ åœ¨ GAS æœ‰ä¿®æ”¹éå¾Œç«¯ä¸¦ã€Œé‡æ–°éƒ¨ç½²ã€ï¼Œé€™å€‹ URL å°±è¦è·Ÿè‘—æ›ï¼
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyJbzjHIeFFRbqT-Ttk2OAPYfF-qDKYES8dJiu4sJCR4t2Fq9PTtbALwuiJDBxh55kR/exec";
    
    let isProcessing = false;
    let html5QrCode = null;
    let cameraList = [];
    let currentCameraIndex = 0;

    async function initScanner() {
      // ğŸš€ åŠ é€Ÿç§˜è¨£ 1ï¼šé™åˆ¶åªè¾¨è­˜ QR Codeï¼Œæ¸›è¼• CPU è² æ“”
      const formatsToSupport = [ Html5QrcodeSupportedFormats.QR_CODE ];
      html5QrCode = new Html5Qrcode("reader", { formatsToSupport: formatsToSupport });
      
      try {
        cameraList = await Html5Qrcode.getCameras();
        if (cameraList.length > 0) {
          currentCameraIndex = cameraList.findIndex(d => d.label.toLowerCase().includes('back') || d.label.toLowerCase().includes('rear'));
          if (currentCameraIndex === -1) currentCameraIndex = cameraList.length - 1;
          startCurrentCamera();
        }
      } catch (err) { alert("ç›¸æ©ŸéŒ¯èª¤: " + err); }
    }

    function startCurrentCamera() {
      const cameraId = cameraList[currentCameraIndex].id;
      
      // ğŸš€ åŠ é€Ÿç§˜è¨£ 2ï¼šæå‡ FPS ä¸¦å˜—è©¦é–‹å•Ÿé€£çºŒå°ç„¦
      const config = { 
        fps: 30, // æå‡åˆ° 30
        qrbox: (w, h) => { const s = Math.min(w, h) * 0.7; return { width: s, height: s }; },
        videoConstraints: {
          facingMode: "environment",
          advanced: [{ focusMode: "continuous" }] 
        }
      };

      html5QrCode.start(cameraId, config, (text) => { 
        if (!isProcessing) handleScan(text.trim()); 
      }).catch(err => {
        // å¦‚æœé€²éšç›¸æ©Ÿåƒæ•¸ä¸è¢«èˆŠæ‰‹æ©Ÿæ”¯æ´ï¼Œé€€å›åŸºæœ¬è¨­å®šé‡è©¦
        html5QrCode.start(cameraId, { fps: 20, qrbox: 250 }, (text) => {
           if (!isProcessing) handleScan(text.trim());
        });
      });
    }

    async function switchCamera() {
      if (cameraList.length < 2) return;
      if (html5QrCode.isScanning) await html5QrCode.stop();
      currentCameraIndex = (currentCameraIndex + 1) % cameraList.length;
      startCurrentCamera();
    }

    async function handleScan(data) {
      isProcessing = true;
      
      const flash = document.getElementById('flash');
      const reader = document.getElementById('reader');
      const tip = document.getElementById('status-tip');
      
      flash.style.display = 'block'; 
      reader.classList.add('scan-success-effect'); 
      tip.innerText = "âœ… æƒææˆåŠŸï¼š" + data;
      tip.style.background = "#28a745";

      if (navigator.vibrate) navigator.vibrate([100, 50, 100]); 

      const urlParams = new URLSearchParams(window.location.search);
      const uid = urlParams.get('userId') || urlParams.get('uid') || 'Unknown';
      
      // ğŸš€ é—œéµä¿®å¾©ï¼šåŠ ä¸Š mode: 'no-cors'ï¼Œé¿å… GAS é˜»æ“‹è·¨åŸŸè«‹æ±‚è€Œå ±éŒ¯
      try {
        const targetUrl = `${GAS_URL}?action=syncClickToServer&name=${encodeURIComponent(data)}&isChecked=true&userId=${uid}`;
        await fetch(targetUrl, { mode: 'no-cors' }); 
      } catch (e) { 
        // å› ç‚ºä½¿ç”¨äº† no-corsï¼Œé€™è£¡é€šå¸¸åªæœ‰åœ¨çœŸçš„ã€Œæ²’æœ‰ç¶²è·¯ã€æ™‚æ‰æœƒå ±éŒ¯
        tip.innerText = "âŒ ç¶²è·¯é€£ç·šç•°å¸¸"; 
        tip.style.background = "#dc3545";
      }

      // 1.2 ç§’å¾Œæ¢å¾©åŸç‹€ï¼Œæº–å‚™æƒæä¸‹ä¸€å€‹
      setTimeout(() => {
        flash.style.display = 'none';
        reader.classList.remove('scan-success-effect');
        isProcessing = false;
        tip.innerText = "ç­‰å¾… QR Code...";
        tip.style.background = "rgba(0,0,0,0.5)";
      }, 1200); 
    }

    window.onload = initScanner;
  </script>
</body>
</html>

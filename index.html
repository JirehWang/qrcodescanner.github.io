<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>QR Scanner</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; }
    #reader { width: 100vw; height: 100vh; }
    #flash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(40, 167, 69, 0.6); display: none; z-index: 999; pointer-events: none; }
    
    /* æ¥µç°¡åˆ‡æ›æŒ‰éˆ•ï¼šå³ä¸‹è§’åŠé€æ˜åœ“åœˆ */
    #switch-btn {
      position: fixed; bottom: 30px; right: 30px;
      width: 50px; height: 50px; background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.4); border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      z-index: 1000; backdrop-filter: blur(5px); cursor: pointer;
    }
    #switch-btn svg { fill: white; width: 24px; height: 24px; }
  </style>
</head>
<body>

  <div id="flash"></div>
  <div id="reader"></div>
  
  <div id="switch-btn" onclick="switchCamera()">
    <svg viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg>
  </div>

  <script>
    // ğŸš€ å·²ä¿ç•™ä½ æä¾›çš„ GAS ç¶²å€
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzd_3wGa1jwkPyuIA9A1T3X8rq04W9HToZtgB0-3oTw0H3ZPRTdK-QgFGKEPZuGSfU/exec";
    
    let isProcessing = false;
    let html5QrCode = null;
    let cameraList = [];
    let currentCameraIndex = 0;

    // 1. åˆå§‹åŒ–ä¸¦å–å¾—ç›¸æ©Ÿåˆ—è¡¨
    async function initScanner() {
      html5QrCode = new Html5Qrcode("reader");
      try {
        cameraList = await Html5Qrcode.getCameras();
        if (cameraList && cameraList.length > 0) {
          // é è¨­å°‹æ‰¾å¾Œé¡é ­ï¼Œæ‰¾ä¸åˆ°å°±ç”¨æœ€å¾Œä¸€å€‹
          currentCameraIndex = cameraList.findIndex(d => 
            d.label.toLowerCase().includes('back') || d.label.toLowerCase().includes('rear')
          );
          if (currentCameraIndex === -1) currentCameraIndex = cameraList.length - 1;
          
          startCurrentCamera();
        } else {
          alert("æ‰¾ä¸åˆ°ç›¸æ©Ÿè¨­å‚™");
        }
      } catch (err) {
        alert("ç„¡æ³•è®€å–ç›¸æ©Ÿï¼š" + err);
      }
    }

    // 2. å•Ÿå‹•é¸å®šçš„ç›¸æ©Ÿ
    function startCurrentCamera() {
      const cameraId = cameraList[currentCameraIndex].id;
      html5QrCode.start(
        cameraId, 
        { 
          fps: 15, 
          qrbox: (w, h) => { 
            const s = Math.min(w, h) * 0.7; 
            return { width: s, height: s }; 
          } 
        },
        (text) => { if (!isProcessing) handleScan(text.trim()); }
      ).catch(err => console.error("å•Ÿå‹•å¤±æ•—", err));
    }

    // 3. æŒ‰éˆ•é»æ“Šï¼šåˆ‡æ›åˆ°ä¸‹ä¸€å€‹é¡é ­
    async function switchCamera() {
      if (cameraList.length < 2) return;
      
      if (html5QrCode && html5QrCode.isScanning) {
        await html5QrCode.stop();
      }
      
      currentCameraIndex = (currentCameraIndex + 1) % cameraList.length;
      startCurrentCamera();
    }

    // 4. æƒæè™•ç† (ä¿ç•™ä½ åŸæœ¬çš„é‚è¼¯)
    async function handleScan(data) {
      isProcessing = true;
      document.getElementById('flash').style.display = 'block';
    
      // ğŸš€ å¾ç¶²å€æŠ“å– uid åƒæ•¸ï¼Œå¦‚æœæ²’æœ‰å°±ç”¨é è¨­
      const urlParams = new URLSearchParams(window.location.search);
      const uid = urlParams.get('uid') || 'Unknown_Device';
    
      try {
        // å‚³é€æ™‚å¸¶ä¸Š userId
        const target = `${GAS_URL}?action=syncClickToServer&name=${encodeURIComponent(data)}&isChecked=true&userId=${uid}`;
        await fetch(target);
      } catch (e) { console.error("å‚³é€å¤±æ•—"); }
    
      setTimeout(() => {
        document.getElementById('flash').style.display = 'none';
        isProcessing = false;
      }, 1500);
    }

    window.onload = initScanner;
  </script>
</body>
</html>
